<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyU GPA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --polyu-red: #a6192e; --polyu-gold: #85714d; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        .navbar { background-color: var(--polyu-red); color: white; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border-radius: 15px; border: none; box-shadow: 0 8px 24px rgba(0,0,0,0.05); transition: 0.3s; }
        .gpa-display { font-size: 4rem; font-weight: 800; color: var(--polyu-red); line-height: 1; }
        .btn-polyu { background-color: var(--polyu-red); color: white; }
        .btn-polyu:hover { background-color: #8a1526; color: white; }
        .project-item.active { background-color: var(--polyu-red) !important; border-color: var(--polyu-red) !important; }
        .delete-icon { color: #dee2e6; cursor: pointer; transition: 0.2s; }
        .delete-icon:hover { color: #dc3545; }
        .cloud-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 10px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <span class="navbar-brand mb-0 h1">PolyU GPA 计算器</span>
    </div>
</nav>

<div class="container">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card p-4 mb-4">
                <h5 class="fw-bold mb-3">学期/专业管理</h5>
                <div class="list-group mb-3" id="project-list" style="max-height: 300px; overflow-y: auto;"></div>
                <button class="btn btn-outline-primary w-100 mb-3" onclick="createNewProject()">+ 新建学期/专业</button>
                <hr>
                <h6 class="fw-bold">云端同步</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="saveToCloud()">保存到云端</button>
                    <button class="btn btn-info text-white" onclick="loadFromCloud()">从云端加载</button>
                </div>
                <div id="cloud-info" class="mt-2 small text-center text-primary fw-bold"></div>
            </div>

            <div class="card p-4 text-center">
                <h6 class="text-muted fw-bold small uppercase">cGPA (PolyU)</h6>
                <div class="gpa-display" id="display-gpa">0.00</div>
                <div class="mt-2 text-muted">WES 4.0 转换: <span id="display-wes">0.00</span></div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0" id="current-project-name">加载中...</h4>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCurrentProject()">删除项目</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>课程名</th>
                                <th style="width: 100px;">学分</th>
                                <th style="width: 160px;">等级</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="course-body"></tbody>
                    </table>
                </div>
                <button class="btn btn-polyu w-100 mt-2" onclick="addCourseRow()">+ 添加课程</button>
            </div>
        </div>
    </div>
</div>

<script>
    const POLYU_GRADES = { "A+": 4.3, "A": 4.0, "A-": 3.7, "B+": 3.3, "B": 3.0, "B-": 2.7, "C+": 2.3, "C": 2.0, "C-": 1.7, "D+": 1.3, "D": 1.0, "F": 0.0 };
    const WES_GRADES = { "A+": 4.0, "A": 4.0, "A-": 3.7, "B+": 3.3, "B": 3.0, "B-": 2.7, "C+": 2.3, "C": 2.0, "C-": 1.7, "D+": 1.3, "D": 1.0, "F": 0.0 };
    const MASTER_KEY = "$2a$10$6Rz3G.7Lh7H5rF0T5T9.ReX8vXvXvXvXvXvXvXvXvX"; 

    let appState = JSON.parse(localStorage.getItem('poly_gpa_v2')) || {
        projects: { "init": { name: "Year 2 Semester 1", courses: [{ name: "Example Class", credit: 3, grade: "A" }] } },
        currentId: "init",
        cloudBinId: ""
    };

    function init() { renderProjectList(); renderCourses(); updateCloudStatus(); }

    function updateCloudStatus() {
        if (appState.cloudBinId) document.getElementById('cloud-info').innerText = "云端 ID: " + appState.cloudBinId;
    }

    function createNewProject() {
        const name = prompt("项目名称:", "Year 2 Sem 2");
        if (!name) return;
        const id = 'p' + Date.now();
        appState.projects[id] = { name: name, courses: [] };
        appState.currentId = id;
        saveAll();
    }

    function switchProject(id) { appState.currentId = id; saveAll(); }

    function renderProjectList() {
        const list = document.getElementById('project-list');
        list.innerHTML = '';
        Object.keys(appState.projects).forEach(id => {
            const btn = document.createElement('button');
            btn.className = `list-group-item list-group-item-action ${id === appState.currentId ? 'active' : ''}`;
            btn.innerText = appState.projects[id].name;
            btn.onclick = () => switchProject(id);
            list.appendChild(btn);
        });
    }

    function addCourseRow() {
        appState.projects[appState.currentId].courses.push({ name: '', credit: 3, grade: 'A' });
        saveAll();
    }

    function renderCourses() {
        const project = appState.projects[appState.currentId];
        document.getElementById('current-project-name').innerText = project.name;
        const body = document.getElementById('course-body');
        body.innerHTML = '';
        project.courses.forEach((c, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="form-control" value="${c.name}" onchange="updateCourse(${i},'name',this.value)"></td>
                <td><input type="number" class="form-control" value="${c.credit}" onchange="updateCourse(${i},'credit',this.value)"></td>
                <td><select class="form-select" onchange="updateCourse(${i},'grade',this.value)">
                    ${Object.keys(POLYU_GRADES).map(g => `<option value="${g}" ${c.grade===g?'selected':''}>${g}</option>`).join('')}
                </select></td>
                <td class="text-center"><span class="delete-icon" onclick="removeCourse(${i})">✕</span></td>`;
            body.appendChild(tr);
        });
        calculate();
    }

    function updateCourse(i, f, v) {
        appState.projects[appState.currentId].courses[i][f] = f === 'credit' ? parseFloat(v) : v;
        saveAll();
    }

    function removeCourse(i) { appState.projects[appState.currentId].courses.splice(i, 1); saveAll(); }

    function deleteCurrentProject() {
        if (Object.keys(appState.projects).length <= 1) return;
        if (confirm("删除项目？")) {
            delete appState.projects[appState.currentId];
            appState.currentId = Object.keys(appState.projects)[0];
            saveAll();
        }
    }

    // 核心修改：四舍五入保留2位
    function calculate() {
        const courses = appState.projects[appState.currentId].courses;
        let totalC = 0, totalP = 0, totalWP = 0;
        courses.forEach(c => {
            const cr = parseFloat(c.credit) || 0;
            totalC += cr;
            totalP += POLYU_GRADES[c.grade] * cr;
            totalWP += WES_GRADES[c.grade] * cr;
        });
        // 使用 toFixed(2) 自动实现四舍五入并保留两位小数
        document.getElementById('display-gpa').innerText = totalC ? (totalP/totalC).toFixed(2) : "0.00";
        document.getElementById('display-wes').innerText = totalC ? (totalWP/totalC).toFixed(2) : "0.00";
    }

    function saveAll() {
        localStorage.setItem('poly_gpa_v2', JSON.stringify(appState));
        renderProjectList();
        renderCourses();
    }

    async function saveToCloud() {
        const info = document.getElementById('cloud-info');
        info.innerText = "正在同步...";
        const isUpdate = !!appState.cloudBinId;
        const url = isUpdate ? `https://api.jsonbin.io/v3/b/${appState.cloudBinId}` : `https://api.jsonbin.io/v3/b`;
        try {
            const res = await fetch(url, {
                method: isUpdate ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                body: JSON.stringify(appState)
            });
            const result = await res.json();
            if (res.ok) {
                if (!isUpdate) { appState.cloudBinId = result.metadata.id; saveAll(); }
                alert("同步成功！ID: " + appState.cloudBinId);
                updateCloudStatus();
            }
        } catch (e) { alert("网络错误"); }
    }

    async function loadFromCloud() {
        const id = prompt("输入 ID:", appState.cloudBinId);
        if (!id) return;
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${id}/latest`, { headers: { 'X-Master-Key': MASTER_KEY } });
            const result = await res.json();
            if (res.ok) { appState = result.record; saveAll(); init(); }
        } catch (e) { alert("加载失败"); }
    }

    init();
</script>
</body>
</html>